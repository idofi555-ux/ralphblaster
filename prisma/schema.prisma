// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Project {
  id            String    @id @default(cuid())
  name          String
  description   String?   // Short project description
  codePath      String    // Local path to codebase, e.g., "/Users/me/dev/myproject"
  gitUrl        String?   // Git repository URL if imported from git
  productionUrl String?   // Production deployment URL
  color         String    @default("#3B82F6") // Blue default
  importedAt    DateTime? // When the project was imported
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  tickets       Ticket[]
}

model Ticket {
  id                String       @id @default(cuid())
  title             String
  description       String       @db.Text
  status            TicketStatus @default(BACKLOG)
  priority          Priority     @default(MEDIUM)

  // PRD fields
  prdContent        String?      @db.Text
  prdGeneratedAt    DateTime?

  // Ralph execution fields
  ralphInstancePath String?
  ralphStatus       RalphStatus?
  ralphStartedAt    DateTime?
  ralphCompletedAt  DateTime?
  ralphLogs         String?      @db.Text

  // Relations
  project           Project      @relation(fields: [projectId], references: [id])
  projectId         String

  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt
}

enum TicketStatus {
  BACKLOG
  UP_NEXT
  IN_REVIEW
  IN_PROGRESS
  IN_TESTING
  COMPLETED
}

enum Priority {
  LOW
  MEDIUM
  HIGH
}

enum RalphStatus {
  LAUNCHING
  RUNNING
  COMPLETED
  FAILED
}

model Settings {
  id                  String   @id @default("global")
  claudeModel         String   @default("claude-sonnet-4-5-20250514")
  maxTokens           Int      @default(4096)
  claudeCliPath       String   @default("/usr/local/bin/claude")
  logRetentionCount   Int      @default(100)
  statusPollInterval  Int      @default(1500)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
}

model SecurityTest {
  id          String   @id @default(cuid())
  name        String
  command     String
  description String?
  enabled     Boolean  @default(true)
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model HostingConfig {
  id               String   @id @default("global")
  provider         String   @default("railway")
  cliPath          String?
  projectToken     String?
  autoDeployBranch String?  @default("main")
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}

model SystemLog {
  id        String   @id @default(cuid())
  level     String   // INFO, WARN, ERROR
  category  String   // SYSTEM, RALPH, API, etc.
  message   String
  details   String?  @db.Text
  createdAt DateTime @default(now())
}

model ApiUsageLog {
  id           String   @id @default(cuid())
  type         String   // prd_generation, ralph_execution, etc.
  ticketId     String?
  ticketTitle  String?
  projectId    String?
  tokensUsed   Int?
  cost         Float?
  model        String?
  duration     Int?     // milliseconds
  metadata     String?  @db.Text
  createdAt    DateTime @default(now())
}
